<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'/>
  <link href='/ext/codemirror.css' rel='stylesheet' />
  <link href='/ext/mapbox.css' rel='stylesheet' />
  <link href='/ext/base/base.css' rel='stylesheet' />
  <link href='/app/app.css' rel='stylesheet' />
  <link href='/app/style.css' rel='stylesheet' />
  <script src='/ext/underscore-min.js'></script>
  <script src='/ext/codemirror.js'></script>
  <script src='/ext/codemirror.runmode.js'></script>
  <script src='/ext/jquery-2.0.3.min.js'></script>
  <script src='/ext/jquery.sortable.js'></script>
  <script src='/ext/backbone.js'></script>
  <script src='/ext/mapbox.js'></script>
  <script src='/app/lib.js'></script>
  <script src='/app/codemirror.carto.js'></script>
  <script src='/app/codemirror.carto.complete.js'></script>
  <title><%= style.name %></title>
</head>

<body id='view'>

<div id='perf'></div>

<div id='data' class='pane fill-grey scroll-styled w3 l1'>
  <section class='pad2 keyline-bottom'>
    <h3>Sources</h3>
    <nav class='pin-topright pad1'>
      <a class='button icon quiet close' href='#layers'></a>
    </nav>
  </section>
  <div class='grid pad1 clearfix'><!--
  <%
    print(_(history.source).chain()
      .sortBy(function(item) {
        return (item.name||'').toLowerCase();
      })
      .map(function(item) {
        return this.sourceitem(_({active:item.id === style.source}).defaults(item));
      }.bind(this))
      .value().join(''));
  %>
  --></div>
</div>

<form id='settings' class='pane fill-grey scroll-styled w4 l0'>
<div class='column w2 l0 lighten scroll-styled'>
  <%= this.history(obj) %>
</div>
<div class='scroll-styled column w2 l2'>
  <header class='pad2 keyline-bottom'>
    <h3>Settings</h3>
    <nav class='pin-topright pad1'>
      <a class='inline quiet pad1 icon close' href='#'></a>
    </nav>
  </header>
  <div class='pad2'>
    <fieldset>
      <section class='space-bottom1'>
        <label>Name</label>
        <input class='stretch' name='name' type='text' value='<%= _(style.name).escape() %>'/>
      </section>
      <section class='space-bottom1'>
        <label>Description</label>
        <textarea class='stretch' name='description' type='text' cols='60' rows='8'><%= style.description %></textarea>
      </section>
      <section class='space-bottom1'>
        <label>Attribution</label>
        <input class='stretch' name='attribution' type='text' value='<%= _(style.attribution).escape() %>'></textarea>
      </section>
    </fieldset>
    <fieldset class='pad2 space-bottom2 keyline-all round'>
      <section class='clearfix'>
        <label class='inline col3'>Image format</label>
        <select name='format'>
          <% _({
            'png24': 'png (24-bit)',
            'png8:m=h': 'png (256 colors)',
            'png8:m=h:c=192': 'png (192 colors)',
            'png8:m=h:c=128': 'png (128 colors)',
            'png8:m=h:c=64': 'png (64 colors)',
            'png8:m=h:c=32': 'png (32 colors)',
            'jpeg95': 'jpeg (95%)',
            'jpeg90': 'jpeg (90%)',
            'jpeg85': 'jpeg (85%)',
            'jpeg80': 'jpeg (80%)'
          }).each(function(label, format) { %>
          <option value='<%= format %>' <% if (style.format === format) { %> selected='selected' <% } %>><%= label %></option>
          <% }); %>
        </select>
      </section>
      <section class='clearfix'>
        <label class='inline col3'>Minzoom</label>
        <input id='minzoom' name='minzoom' class='min' type='range' value='<%= style.minzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "max", "#maxzoom");' />
        <label class='inline range small strong' id='minzoom-val'><%= style.minzoom %></label>
      </section>
      <section class='clearfix'>
        <label class='inline col3'>Maxzoom</label>
        <input id='maxzoom' name='maxzoom' class='max' type='range' value='<%= style.maxzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "min", "#minzoom");' />
        <label class='inline  range small strong' id='maxzoom-val'><%= style.maxzoom %></label>
      </section>
      <section class='clearfix'>
        <label class='inline col3'>Scale</label>
        <input id='scale' name='scale' type='range' value='<%= style.scale %>' min='1' max='4' step='1' onchange='rangeHandler(this, "scale", "#scale");' />
        <label class='inline  range small strong' id='scale-val'><%= style.scale %></label>
      </section>
    </fieldset>

    <section class='pill col6 margin6 clearfix'><!--
      --><a href='#' class='button col6 wide submit icon okay floppy'>Save</a><!--
      --><a href='/style.tm2z?id=<%=style.id%>' class='col6 button wide submit icon folder'>Package</a>
    </section>
  </div>
</div>
</form>

<div id='layers' class='menu column w1 dark hide fill-dark'>
  <nav class='row1 col12 pin-top fill-dark keyline-bottom z100'>
  <div class='pin-topleft'><!--
    --><a href='#' class='align-middle inline pad1 icon close'></a><!--
    --><a href='#data' class='button short data-n icon plus quiet'>Data</a><!--
    --><a href='#layers' class='button short data-y icon x quiet'>Data</a>
    </div>
  </nav>
  <div class='menu-content pin-left col12 pad4y scroll-styled'>
  <%= _(sources).map(this.sourcelayers).join('\n') %>
  </div>
</div>

<div id='full' class='column w2 l0'>

  <div id='title' class='contain row1 pin-top col12 center pad1y keyline-bottom fill-darken0 z1'>
    <div class='pin-left'><!--
      --><a class='inline pad1 icon menu quiet unround align-middle' href='#layers'></a><!--
      <% if (style._tmp) { %>
        --><a class='button short icon floppy okay quiet' href='#saveas'>Save as</a>
      <% } else { %>
        --><a class='button short icon floppy okay quiet' href='#'>Save</a>
      <% } %>
    </div>
    <div class='pin-right'>
      <a class='full-n pad1 inline icon l-r-arrow quiet unround' href='#full'></a>
      <a class='full-y pad1 quiet icon close unround' href='#'></a>
    </div>
    <h3><a href='#settings' class='small strong quiet'>
      <span class='name icon sprocket'><%= style.name || 'Untitled' %></span>
    </a></h3>
  </div>

  <div id='map' style='background-color:<%=style.background%>;'></div>
  <div id='map-overlay' class='overlay'></div>
  <div id='map-errors'></div>
  <div id='zoomedto' class='fill-white z<%=style.center[2]%>'></div>
</div>

<div id='docs' class='pane fill-grey scroll-styled w2'>
  <%= this['styledocs'](cartoRef) %>
</div>

<div id='fonts' class='pane fill-grey scroll-styled w2'>
  <header class='pad2x pad0y keyline-bottom'>
    <h3 class='icon pad0y font'>Fonts</h3>
    <nav class='pin-topright'>
      <a class='inline pad1 icon quiet return' href='#docs'></a>
    </nav>
  </header>
  <div class='grid pad2 clearfix'>
    <div class='clearfix keyline-top keyline-bottom keyline-left'><!--
    <% fontsRef.forEach(function(font) { %>
    --><div class='col6 keyline-bottom keyline-right'><span class='pad0 single-font' style='background-image:url("/font.png?id=<%=font%>")'><%=font%></span></div><!--
    <% }); %>
    --></div>
  </div>
</div>

<div id='code' class='column w2 l2'>
  <div class='pin-topleft docs-button fill-darken0 z1'>
    <a class='keyline-right pad1 inline quiet docs-n icon info' href='#docs'></a>
    <a class='keyline-right pad1 inline docs-y icon quiet close unround' href='#'></a>
  </div>
  <nav id='tabs' class='keyline-left keyline-bottom row1 pad0y pad4x pad0r pin-top fill-darken0 small'><!--
    --><a rel='template' href='#code-template' class='tab round quiet mini'><span class='icon tooltip'></span></a><!--
    <% _(style.styles).keys().forEach(function(k,i) { %>
    --><a rel='<%=k%>' href='#code-<%=k.replace(/[^\w+]/g,'_')%>' class='strong quiet tab round pad0y pad1x truncate contain <%=!i?'active':''%>'><%=k%> <span class='icon trash delete'></span></a><!--
    <% }); %>
  -->
  <span class='z1'>
    <a class='tab inline round pad0 short quiet icon strong small plus' href='#addtab'></a>
  </span>
  </nav>
  <form id='interactivity' class='space row1 pad1 keyline-bottom pin-top'>
    <label class='small'>Layer</label>
    <select name='interactivity_layer'>
      <option value=''>&lt; choose layer &gt;</option>
      <% _(sources).each(function(source) { %>
      <% _(source.vector_layers||{}).each(function(l) { %>
      <option value='<%=l.id%>' <% if (style.interactivity_layer === l.id) { %>selected='selected'<% } %>><%=l.id%></option>
      <% }); %>
      <% }); %>
    </select>
  </form>
</div>

<%= this.modalmessage() %>
<%= this.modalmapbox() %>
<%= this.modalbrowseropen({cwd:cwd, type:'style'}) %>
<%= this.modalbrowseropen({cwd:cwd, type:'source'}) %>
<%= style._tmp ? this.modalbrowsersave({cwd:cwd, type:'style'}) : '' %>

<form id='addtab' class='modal center round pad2 col6 margin3 fill-light'>
  <a class='pad1 quiet submit icon x pin-topright' href='#'></a>
  <div class='clearfix'>
    <span class='input-pill pill col8 margin2'>
      <input class='col8' type='text' placeholder='filename.mss' size='20' id='addtab-filename' pattern='\w+\.mss'/><!--
      --><input class='col4 round-right' type='submit' value='New tab'/>
    </span>
  </div>
</form>

<div id='mask' class='fill-darken2 animate'></div>

<script>
var map = baselayer = tiles = grids = gridc = null;

var templates = {};
templates.sourceitem = <%= this.sourceitem.source %>;
templates.sourcelayers = <%= this.sourcelayers.source %>;

statHandler('drawtime')();

var Tab = function(id, value) {
  var tab = CodeMirror(document.getElementById('code'), {
    value: value,
    lineNumbers: true,
    mode: {
      name: 'carto',
      reference: window.cartoRef
    }
  });
  var completer = cartoCompletion(tab, window.cartoRef);

  /*
  @TODO
  function updateSelectors(model) {
      var ids = _.map(model.get('Layer').pluck('id'),
          function(x) { return '#' + x; });
      var classes = _(model.get('Layer').pluck('class')).chain().map(
          function(c) {
              if (c == undefined) return '';
              var cs = c.split(' ');
              if (cs[0] == '') return '';
              return _.map(cs, function(x) { return '.' + x; });
          }).flatten().compact().value();
      cartoCompleter.ids(ids);
      cartoCompleter.classes(classes);
  }
  this.model.bind('change', updateSelectors);
  updateSelectors(this.model);
  */

  tab.setOption('onKeyEvent', completer.onKeyEvent);
  tab.setOption('onHighlightComplete', _(completer.setTitles).throttle(100));
  tab.getWrapperElement().id = 'code-' + id.replace(/[^\w+]/g,'_');
  return tab;
};
var code = _(<%=JSON.stringify(style.styles)%>).reduce(function(memo, value, k) {
  memo[k] = Tab(k, value);
  return memo;
}, {});

// Add in interactivity template.
code['template'] = Tab('template', <%=JSON.stringify(style.template)%>);

_(code).toArray().shift().getWrapperElement().className += ' active';

var Style = Backbone.Model.extend({});
Style.prototype.url = function() { return '/style.json?id=' + this.get('id'); };

var Source = Backbone.Model.extend({});
Source.prototype.url = function() { return '/source.json?id=' + this.get('id'); };

var Editor = Backbone.View.extend({});
Editor.prototype.events = {
  'click a.button.save': 'save',
  'click a.button.recache': 'recache',
  'submit #settings': 'save',
  'submit #addtab': 'addtab',
  'submit #addmapbox': 'addmapbox',
  'click #tabs a.tab span.delete': 'deltab',
  'click #tabs a.tab': 'tabbed',
  'click #docs nav a': 'tabbed',
  'click #menu nav a': 'tabbed',
  'click #settings a.tab': 'tabbed',
  'click #layers a': 'tabbed',
  'click #data a.cell': 'adddata',
  'keydown': 'keys'
};
Editor.prototype.keys = function(ev) {
  // Escape. Collapses windows, dialogs, modals, etc.
  if (ev.which === 27) {
    window.location.href = '#';
  }
  if ((!ev.ctrlKey && !ev.metaKey) || ev.altKey || ev.shiftKey) return;
  switch (ev.which) {
  case 83: // s
    this.save();
    break;
  case 187: // +
    map.zoomBy(1);
    break;
  case 189: // -
    map.zoomBy(-1);
    break;
  default:
    return true;
  }
  return false;
};
Editor.prototype.tabbed = tabbedHandler;
Editor.prototype.addmapbox = addMapBox;
Editor.prototype.adddata = function(ev) {
  var target = $(ev.currentTarget);
  if (target.is('.active')) return false;
  var id = target.attr('href').split('#source-').pop();
  (new Source({id:id})).fetch({
    success: _(function(model, resp) {
      $('#data a.active').removeClass('active');
      $('#layers .menu-content').html(templates.sourcelayers(resp));
      target.addClass('active');
    }).bind(this),
    error: _(this.error).bind(this)
  });
  return false;
};
Editor.prototype.addtab = function(ev) {
  var filename = $('#addtab-filename').val();
  if (!code[filename]) {
    $("<a rel='"+filename+"' href='#code-"+filename.replace(/[^\w+]/g,'_')+"' class='strong quiet tab round pad0y pad1x truncate contain'>"+filename+" <span class='icon trash delete'></span></a>").insertAfter('nav#tabs > a:last-of-type');
    code[filename] = Tab(filename, '');
  }
  window.location.hash = '#';
  return false;
};
Editor.prototype.deltab = function(ev) {
  var styles = this.model.get('styles');
  var parent = $(ev.currentTarget).parent();
  var target = parent.attr('rel');
  if (!styles[target]) return false;
  if (confirm('Remove stylesheet "' + target + '"?')) {
    $(code[target].getWrapperElement()).remove();
    parent.remove();
    delete styles[target];
    delete code[target];
    this.model.set({styles:styles});
    // Set first tab to active.
    if (parent.is('.active') && $('a.tab').size())
      this.tab({ currentTarget:$('a.tab').get(0) });
  }
  return false;
};
Editor.prototype.recache = function(ev) {
  this.model.set({_recache:true});
  this.save(ev);
  return false;
};
Editor.prototype.save = function(ev, options) {
  // Set map in loading state.
  $('#full').addClass('loading');

  var attr = {};
  // Grab settings form values.
  _($('#settings').serializeArray()).reduce(function(memo, field) {
    if (field.name === 'minzoom' || field.name === 'maxzoom' || field.name === 'scale') {
      memo[field.name] = parseInt(field.value,10);
    } else if (field.name && field.value) {
      memo[field.name] = field.value;
    }
    return memo;
  }, attr);
  // Grab interactivity form values.
  _($('#interactivity').serializeArray()).reduce(function(memo, field) {
    memo[field.name] = field.value;
    return memo;
  }, attr);
  // Grab styles, sources.
  attr.styles = _(code).reduce(function(memo, cm, k) {
    if (k !== 'template') memo[k] = cm.getValue();
    return memo;
  }, {});
  attr.source = $('#layers div.source').map(function() {
    return $(this).attr('id').split('source-').pop();
  }).get().shift();
  attr.template = code.template ? code.template.getValue() : '';

  if (this.model.get('_prefs').saveCenter) {
    var lon = map.getCenter().lng % 360;
    lon += (lon < -180) ? 360 : (lon > 180) ? -360 : 0;
    attr.center = [lon , map.getCenter().lat, map.getZoom() ];
  }

  options = options || {
    success:_(this.refresh).bind(this),
    error: _(this.error).bind(this)
  };
  this.model.save(attr, options);

  return ev && !!$(ev.currentTarget).is('a');
};
Editor.prototype.error = function(model, resp) {
  this.messageClear();

  if (!resp.responseText)
    return this.messageModal('Could not save style "' + model.id + '"');

    // Assume carto.js specific error array format response.
  _(JSON.parse(resp.responseText).message.toString().split('\n')).chain()
    .compact()
    .map(function(e) { return e.match(/^(Error: )?([\w.]+):([\d]+):([\d]+) (.*)$/) || e; })
    .each(_(function(e) {
      if (_(e).isArray()) {
        var id = e[2];
        var ln = parseInt(e[3]) - 1;
        code[id]._cartoErrors = code[id]._cartoErrors || [];
        code[id]._cartoErrors.push(ln);
        code[id].setMarker(ln, "<a id='error-"+ln+"' href='#error-"+ln+"'>%N%</a><span class='message'><a href='#' class='icon'>✕</a>"+e[5]+"</span>", 'error');
      } else {
        return this.messageModal(e);
      }
    }).bind(this));
};
Editor.prototype.messageModal = function(text) {
  $('#message .message').text(text);
  window.location.hash = '#message';
};
Editor.prototype.messageClear = function() {
  $('#message .message').text('');
  $('#full').removeClass('loading');
  _(code).each(function(cm) {
    _(cm._cartoErrors||[]).each(cm.clearMarker);
    delete cm._cartoErrors;
  });
};
Editor.prototype.refresh = function(ev) {
  this.messageClear();

  if (!map) {
    map = L.mapbox.map('map');
    map.setView([this.model.get('center')[1], this.model.get('center')[0]], this.model.get('center')[2]);
    map.on('zoomend', function() { $('#zoomedto').attr('class', 'z' + (map.getZoom()|0)); });
  }
  map.options.minZoom = this.model.get('minzoom');
  map.options.maxZoom = this.model.get('maxzoom');

  // Refresh map baselayer.
  if (this.model.get('_prefs').baselayer) {
    baselayer = baselayer || L.mapbox.tileLayer(this.model.get('_prefs').baselayer).addTo(map);
  } else if (baselayer) {
    map.removeLayer(baselayer);
  }

  // Refresh map layer.
  if (tiles) map.removeLayer(tiles);
  tiles = L.mapbox.tileLayer({
    tiles: ['/style/{z}/{x}/{y}.png?id=<%=style.id%>&mtime=' + this.model.get('mtime') ],
    minzoom: this.model.get('minzoom'),
    maxzoom: this.model.get('maxzoom')
  })
  .on('tileload', statHandler('drawtime'))
  .on('load', errorHandler)
  .addTo(map);

  // Refresh gridcontrol template.
  if (grids) map.removeLayer(grids);
  if (gridc) map.removeControl(gridc);
  if (this.model.get('template') && this.model.get('interactivity_layer')) {
    grids = L.mapbox.gridLayer({
      grids: ['/style/{z}/{x}/{y}.grid.json?id=<%=style.id%>&mtime=' + this.model.get('mtime') ],
      minzoom: this.model.get('minzoom'),
      maxzoom: 22
    });
    gridc = L.mapbox.gridControl(grids, {
      follow: true,
      template: this.model.get('template')
    });
    map.addLayer(grids);
    map.addControl(gridc);
  }

  // Refresh map title.
  $('title').text(this.model.get('name'));
  $('#title .name').text(this.model.get('name') || 'Untitled');

  // Set canvas background color.
  if (this.model.get('background'))
    $('#map').css({'background-color':this.model.get('background')});

  return false;
};
var editor = new Editor({
  el: document.body,
  model: new Style(<%= JSON.stringify(style) %>)
});
editor.refresh();

// Syntax highlighting for carto ref.
$('pre.carto-snippet').each(function(i, elem) {
  var text = $(elem).text();
  $(elem).empty();
  CodeMirror.runMode(text, {name:'carto',reference:window.cartoRef}, $(elem).get(0));
});
</script>
</body>

</html>
