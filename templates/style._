<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'/>
  <link href='/app/icon.png' rel='apple-touch-icon' />
  <link href='/ext/codemirror/codemirror.css' rel='stylesheet' />
  <link href='/ext/mapbox.css' rel='stylesheet' />
  <link href='/ext/base/base.css' rel='stylesheet' />
  <link href='/app/app.css' rel='stylesheet' />
  <link href='/app/style.css' rel='stylesheet' />
  <script src='/ext/underscore-min.js'></script>
  <script src='/ext/codemirror/codemirror.js'></script>
  <script src='/ext/codemirror/runmode.js'></script>
  <script src='/ext/codemirror/searchcursor.js'></script>
  <script src='/ext/jquery-2.0.3.min.js'></script>
  <script src='/ext/jquery.sortable.js'></script>
  <script src='/ext/backbone.js'></script>
  <script src='/ext/mapbox.js'></script>
  <script src='/app/cartoref.js'></script>
  <script src='/app/lib.js?_=<%= +new Date %>'></script>
  <script src='/app/style.js?_=<%= +new Date %>'></script>
  <script src='/app/codemirror.carto.js'></script>
  <script src='/app/codemirror.carto.complete.js'></script>
  <script src='/app/codemirror.tm2.search.js'></script>
  <script src='/app/codemirror.tm2.palette.js'></script>
  <script src='/ext/sexagesimal.js'></script>
  <title><%= style.name %></title>
</head>

<body id='view' class='<%= agent %>'>

<div id='perf'></div>

<div id='modal'>
  <div class='modal-mask fill-darken2 animate'></div>
  <div id='modal-content' class='contain modal-content animate'></div>
</div>

<div id='user' class='z10 col12 pin-top'>
  <a href='#' class='fill-darken1 col12 pin-left pin-bottom'></a>
  <div class='megamenu caret1 fill-light col5 pin-topleft'>
    <%= this.history(obj) %>
  </div>
</div>

<form id='settings' class='z10 col12 pin-top'>
  <a href='#' class='fill-darken1 col12 pin-left pin-bottom'></a>
  <div class='megamenu caret2 fill-light col5 pin-topleft'>
  <a class="pad1 quiet icon x pin-topright" href="#"></a>
    <header class='pad1 keyline-bottom'>
      <h3>Settings</h3>
    </header>
    <div class='pin-left col12 scroll-styled pad2 top1 bottom2'>
      <fieldset>
        <section class='space-bottom1'>
          <label>Name</label>
          <input class='short small stretch' name='name' type='text' value='<%= _(style.name).escape() %>'/>
        </section>
        <section class='space-bottom1'>
          <label>Description</label>
          <textarea class='short small stretch' name='description' type='text' cols='60' rows='8'><%= style.description %></textarea>
        </section>
        <section>
          <label>Attribution</label>
          <input class='short small stretch' name='attribution' type='text' value='<%= _(style.attribution).escape() %>'></input>
        </section>
      </fieldset>
      <fieldset class='pad1 space-bottom2 keyline-all round'>
        <section class='space-bottom1 clearfix'>
          <label class='inline col4'>Image format</label>
          <select name='format'>
            <% _({
              'png24': 'png (24-bit)',
              'png8:m=h': 'png (256 colors)',
              'png8:m=h:c=192': 'png (192 colors)',
              'png8:m=h:c=128': 'png (128 colors)',
              'png8:m=h:c=64': 'png (64 colors)',
              'png8:m=h:c=32': 'png (32 colors)',
              'jpeg95': 'jpeg (95%)',
              'jpeg90': 'jpeg (90%)',
              'jpeg85': 'jpeg (85%)',
              'jpeg80': 'jpeg (80%)'
            }).each(function(label, format) { %>
            <option value='<%= format %>' <% if (style.format === format) { %> selected='selected' <% } %>><%= label %></option>
            <% }); %>
          </select>
        </section>
        <section class='space-bottom0 clearfix'>
          <label class='inline col4'>Minzoom</label>
          <input id='minzoom' name='minzoom' class='min' type='range' value='<%= style.minzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "max", "#maxzoom");' />
          <span class='small quiet code inline range' id='minzoom-val'><%= style.minzoom %></span>
        </section>
        <section class='space-bottom0 clearfix'>
          <label class='inline col4'>Maxzoom</label>
          <input id='maxzoom' name='maxzoom' class='max' type='range' value='<%= style.maxzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "min", "#minzoom");' />
          <span class='small quiet code inline range' id='maxzoom-val'><%= style.maxzoom %></span>
        </section>
        <section class='space-bottom1 clearfix'>
          <label class='inline col4'>Scale</label>
          <input id='scale' name='scale' type='range' value='<%= style.scale %>' min='1' max='4' step='1' onchange='rangeHandler(this, "scale", "#scale");' />
          <span class='small quiet code inline range' id='scale-val'><%= style.scale %></span>
        </section>
        <% if (style._prefs.mapid) { %>
        <section class='space-bottom0 clearfix'>
          <label class='inline col4 pad0y' for='map_id'>Map ID</label>
          <input id='map_id' class='code clean short small col8 readonly' name='mapid' type='text' value='<%= _(style._prefs.mapid).escape() %>' placeholder='Mapbox map id' readonly disabled></input>
        </section>
        <% } %>
      </fieldset>
      <fieldset class='fill-darken0 pad1 round'>
        <div class='space-bottom0 small quiet'><em>Underlay your style with a Mapbox map. For reference only.</em></div>
        <section class='clearfix'>
          <label class='inline col4 pad0y' for='baselayer_id'>Baselayer ID</label>
          <input id='baselayer_id' class='code short small col8' name='baselayer' type='text' value='<%= _(style._prefs.baselayer).escape() %>' placeholder='Mapbox map id'></input>
        </section>
      </fieldset>
    </div>
    <div class='settings-footer pad2y fill-light keyline-top round-bottom pin-bottom'>
      <section class='pad1x col12 clearfix'>
        <div class='pad1x <% if (style._tmp) { %> col12 <% } else { %> col4 <% } %>'>
        <a class='saveas button col12 quiet icon js-save floppy'>Save</a>
        </div>
        <div class='pad1x pill col8'><!--
       <% if (!style._tmp) { %>
        --><a href='/style.tm2z?id=<%=style.id%>' class='button quiet col6 <% if (!user.plan.tm2z) { %>col12<% } %> submit icon package'>Package</a><!--
        <% } %>
        <% if (!style._tmp && user.plan.tm2z) { %>
        --><a href='#settings' id='upload-style' class='button quiet col6 submit icon up'>Upload</a><!--
        <% } %>
     --></div>
      </section>
    </div>
  </div>
</form>

<form id='bookmark' class='tip-bottom z10 contain fill-white round animate'>
  <input id='addbookmark' type='text' class='col12 clean round small' value='' placeholder='Name a bookmark' autocomplete='off' />
  <div class='pin-topright pad0'>
    <input type='submit' class='short quiet button' value='Add' />
  </div>
  <ul id='bookmark-list' class='clip fill-light scroll-styled round-bottom'></ul>
</form>

<form id='search' class='tip-bottom z10 contain fill-white round animate'>
  <input id='dosearch' type='text' class='col12 clean small round' value='' placeholder='Search' autocomplete='off' />
  <div class='pin-topleft pad1'>
    <span class='icon search'></span>
  </div>
  <ul id='search-results' class='clip fill-light scroll-styled round-bottom'></ul>
</form>

<div id='full' class='z1 clip animate pin-left'>
  <div id='title' class='contain inline pin-topleft z1'>
    <span class='inline clip fill-darken3 dark row1 round-bottomright'><!--
      --><a href='#user' class='inline avatar align-middle'><img src='<%= user.avatar %>' /></a><!--
      --><strong class='unround icon paint project-name small js-name inline pad1 truncate'><%= style.name || 'Untitled' %></strong><!--
      --><span class='pad0x row1 inline'><!--
      --><a href='#settings' class='round-left icon sprocket short button inline keyline-right'>Settings</a><!--
      <% if (style._tmp) { %>
        --><a class='saveas round-right short button icon inline floppy'>Save as</a>
      <% } else { %>
        --><a class='round-right js-save short button icon inline floppy' href='#'>Save</a>
      <% } %>
    </span>
  </div>
  <div id='map' class='animate' style='background-color:<%=style.background%>;'></div>
  <div id='map-overlay' class='overlay'></div>
  <div id='map-errors'></div>
  <div id='zoomedto' class='z<%=style.center[2]%>'></div>
  <div id='map-controls'>
    <div class='inline'>
      <div class='z1 fill-white'>
        <a href='#' id='zoom-in' title='Zoom in' class='icon plus keyline-right quiet'></a><!--
        --><a href='#' id='zoom-out' title='Zoom out' class='icon minus keyline-right quiet'></a>
      </div>
    </div>
    <div class='inline'>
      <div class='z1 fill-white'>
        <a href='#search' title='Search' class='search-n keyline-right icon search quiet '></a><!--
        --><a href='#' title='Close search' class='search-y icon keyline-right search fill-dark dark'></a><!--
        --><a href='#bookmark' title='Bookmarks' class='bookmark-n icon marker quiet'></a><!--
        --><a href='#' title='Close bookmarks' class='bookmark-y icon marker fill-dark dark'></a>
      </div>
    </div>
    <a href='#' title='Baselayer visibility' id='baselayer' class='inline icon mt active dark fill-dark' <% if (!style._prefs.baselayer) { %>style='display:none;'<% }%>></a>
    <a href='#' title='Inspector' id='xray' class='inline icon eye fill-white quiet'></a>
    <a href='#full' title='Toggle fullscreen' class='full-n inline fill-white icon fullscreen quiet'></a>
    <a href='#' title='Exit fillscreen' class='full-y fill-dark dark icon fullscreen'></a>
  </div>
</div>

<div id='style-ui' class='animate z1 col6 pin-right fill-light'>

  <div id='data' class='pin-left animate fill-blue dark scroll-styled col6'>
    <section class='pad1 space-bottom1 keyline-bottom contain'>
      <h3>Available sources</h3>
      <a class="pad1 quiet icon x pin-topright" href="#layers"></a>
    </section>
    <%
      print(_(history.source).chain()
        .sortBy(function(item) {
          return (item.name||'').toLowerCase();
        })
        .map(function(item) {
          return this.sourceitem(_({active:item.id === style.source}).defaults(item));
        }.bind(this))
        .value().join(''));
    %>
  </div>

  <div id='docs' class='pane animate pin-left fill-grey scroll-styled col6'>
    <%= this['styledocs'](cartoRef) %>
  </div>

  <div id='fonts' class='pane animate pin-left col6 scroll-styled fill-grey'>
    <header class='pad1x pad0y keyline-bottom'>
      <h3 class='pad0y'>Fonts</h3>
      <nav class='pin-topright'>
        <a class='inline pad1 strong small icon quiet x' href='#docs'></a>
      </nav>
    </header>
    <% fontsRef.forEach(function(font) { %>
    <div class='keyline-bottom'><span class='pad0 single-font' style='background-image:url("/font.png?id=<%=font%>")'><%=font%></span></div>
    <% }); %>
  </div>

  <div id='layers' class='pane animate pin-left col6 menu dark fill-dark scroll-styled'>
    <nav class='row1 pad1 fill-dark keyline-bottom z100'>
      <h3>Active source</h3>
      <a class='pad1 quiet icon x pin-topright' href='#'></a>
    </nav>
    <div class='js-menu-content'>
      <%= _(sources).map(this.sourcelayers).join('\n') %>
    </div>
  </div>

  <div id='code' class='z1 pin-left col12'>
  <div class='row1 fill-light pin-top'>
    <div class='pin-topleft z1 row1'><!--
    --><a title='Documentation' class='pad1 inline quiet docs-n icon help unround align-middle fill-darken0 keyline-right' href='#docs'></a><!--
      --><a title='Documentation' class='pad1 inline dark docs-y icon help unround align-middle fill-darken2 keyline-right' href='#'></a><!--
      --><a title='Data layers' class='pad1 inline quiet layers-n icon point-line align-middle fill-darken0 keyline-right' href='#layers'></a><!--
      --><a title='Data layers' class='pad1 inline dark layers-y icon point-line unround align-middle fill-darken2 keyline-right' href='#'></a>
    </div>
    <nav id='tabs' class='keyline-left row1 keyline-bottom pad0y pin-top fill-darken0 contain small'>
      <a rel='template' href='#code-template' class='pin-topleft template-tab pad0 round tab js-tab quiet icon tooltip'></a>
      <div class='center carto-tabs'><!--
      <% _(style.styles).keys().forEach(function(k,i) { %>
      --><a rel='<%=k%>' href='#code-<%=k.replace(/[^\w+]/g,'_')%>' class='strong quiet tab js-tab round pad0y pad1x truncate <%=!i?'active':''%>'><%=k.replace(/.mss/,'')%> <span class='icon trash js-deltab pin-topright pad1y pad0x round'></span></a><!--
      <% }); %>
      --></div>
      <a href='#' class='js-addtab addtab quiet icon plus pad1y pad0x z1 pin-topright'></a>
    </nav>
  </div>

  <form id='interactivity' class='hidden top1 contain'>
    <div class='fill-white row1 pad1 keyline-bottom pin-top'>
      <a href='#interaction-info' class='pin-right pad1 js-info inline icon info quiet'></a>
      <div id='interaction-info' class='clearfix pin-top top1 z10 pad1 keyline-bottom small fill-white hidden'>
        <p>Select a layer from the dropdown, and then place an attribute in brackets like <code>{{{attribute}}}</code>. You can combine tags with plain text. For example, <code>{{{featuretype}}} is {{{depth}}} meters deep</code> would result in a popup that read: "lake is 300 meters deep" when hovering over a feature with <span class='quiet'>featuretype:lake</span> and <span class='quiet'>depth:300.</span></p>
      </div>

      <label class='small strong'>Interaction layer</label>
      <select name='interactivity_layer' class='js-layer-options'>
        <option value=''>Choose:</option>
        <% _(sources).each(function(source) { %>
          <% _(source.vector_layers||{}).each(function(l) { %>
            <option value='<%=l.id%>' <% if (style.interactivity_layer === l.id) { %>selected='selected'<% } %>><%=l.id%></option>
          <% }); %>
        <% }); %>
      </select>
    </div>
    <div class='fill-grey pad1 keyline-top fixed-bottomright col6 row4 z10 small'>
      <div class='space-bottom1'>
        <label class='small'>Available properties:</label>
      </div>

      <div class='pad1 round fill-light content scroll-styled space-bottom1'>
        <% _(sources).each(function(source) { %>
          <% _(source.vector_layers||{}).each(function(l) { %>
          <pre rel='<%= l.id %>' class='small space js-layer-option <% if (style.interactivity_layer !== l.id) { %>hidden<% } %>'><% _(l.fields||{}).each(function(desc, name) { %><span>{{{<%= name %>}}}</span><% }); %></pre>
          <% }); %>
        <% }); %>
        <%= this.emptystate({message:'Select an interaction layer to see available properties.'}) %>
      </div>
      <p class='quiet'><a target='_blank' href='http://mustache.github.io/'>Mustache</a> tags are replaced by your data. You can also use the full <a target='_blank' href='http://mustache.github.io/mustache.5.html'>Mustache template language</a> to customize tooltips.</p>
    </div>
  </form>
  </div>
</div>

<%= this.modalmessage() %>
<%= this.modalmapbox() %>
<%= this.modalbrowseropen({cwd:cwd, type:'style'}) %>
<%= this.modalbrowseropen({cwd:cwd, type:'source'}) %>
<%= style._tmp ? this.modalbrowsersave({cwd:cwd, type:'style'}) : '' %>

<form id='addtab' class='modal center round pad2 col6 margin3 pin-top top2 fill-light'>
  <a class="pad1 quiet icon x pin-topright close" href="#"></a>
  <p>Add a new cartoCSS tab to your style.</p>
  <div class='clearfix'>
    <span class='input-pill pill col8 margin2'>
      <input class='col8' type='text' placeholder='stylesheet name' size='20' id='addtab-filename' required/><!--
      --><input class='col4 round-right' type='submit' value='New tab'/>
    </span>
  </div>
</form>

</div>

<script>
var style = <%= JSON.stringify(style) %>;
var templates = {};
templates.sourceitem = <%= this.sourceitem.source %>;
templates.sourcelayers = <%= this.sourcelayers.source %>;
templates.xraycolor = <%= this.xraycolor.source %>;
templates.xraypopup = <%= this.xraypopup.source %>;
Style(templates, style);
</script>

<% if (test) { %>
  <link href='/app/test/mocha.css' rel='stylesheet' />
  <style>body{padding:0;line-height:1;}/*Bad Mocha*/</style>
  <script src='/app/test/chai.js'></script>
  <script src='/app/test/mocha.js'></script>
  <div id='mocha' class='modal target round pad2 col6 scroll-styled row8 margin3 fill-light'></div>
  <a href='#' id='mask' class='fill-darken2 animate'></a>
  <script src='/app/test/app.test.js'></script>
<% } %>

</body>
</html>
