<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'/>
  <link href='/app/icon.png' rel='apple-touch-icon' />
  <link href='/ext/codemirror/codemirror.css' rel='stylesheet' />
  <link href='/ext/mapbox.css' rel='stylesheet' />
  <link href='/ext/base/base.css' rel='stylesheet' />
  <link href='/app/app.css' rel='stylesheet' />
  <link href='/app/source.css' rel='stylesheet' />
  <script src='/ext/underscore-min.js'></script>
  <script src='/ext/codemirror/codemirror.js'></script>
  <script src='/ext/codemirror/runmode.js'></script>
  <script src='/ext/codemirror/sql.js'></script>
  <script src='/ext/jquery-2.0.3.min.js'></script>
  <script src='/ext/jquery.sortable.js'></script>
  <script src='/ext/sexagesimal.js'></script>
  <script src='/ext/backbone.js'></script>
  <script src='/ext/mapbox.js'></script>
  <script src='/app/cartoref.js'></script>
  <script src='/app/lib.js?_=<%= +new Date %>'></script>
  <script src='/app/source.js'></script>
  <title><%= source.name %></title>
</head>

<body id='view' class='<%= agent %> dark'>

<div id='perf'></div>

<div id='modal'>
  <div class='modal-mask fill-darken2 animate'></div>
  <div id='modal-content' class='contain modal-content animate'></div>
</div>

<div id='user' class='z10 col12 pin-top'>
  <a href='#' class='fill-darken1 col12 pin-left pin-bottom'></a>
  <div class='megamenu caret1 fill-dark col5 pin-topleft'>
    <%= this.history(obj) %>
  </div>
</div>

<form id='settings' class='z10 col12 pin-top'>
  <a href='#' class='fill-darken1 col12 pin-left pin-bottom'></a>
  <div class='pin-topleft megamenu caret2 dark fill-dark col4'>
    <% var disabled = remote ? "disabled='disabled'" : ''; %>
    <a class="pad1 quiet icon x pin-topright" href="#"></a>
    <header class='pad1 keyline-bottom'>
      <h3>Settings</h3>
    </header>

    <div class='pin-left col12 settings-body scroll-styled pad2'>
      <fieldset>
        <section class='space-bottom1'>
          <label>Name</label>
          <input <%= disabled %> class='stretch short small' name='name' type='text' value='<%= _(source.name).escape() %>'/>
        </section>
        <section class='space-bottom1'>
          <label>Description</label>
          <textarea <%= disabled %> class='stretch short small' name='description' type='text' cols='60' rows='8'><%= source.description %></textarea>
        </section>
        <section class='space-bottom1'>
          <label>Attribution</label>
          <input <%= disabled %> class='stretch short small' name='attribution' type='text' value='<%= _(source.attribution).escape() %>'></textarea>
        </section>
      </fieldset>
      <fieldset class='pad1 space-bottom2 keyline-all round'>
        <section class='space-bottom0 clearfix'>
          <label class='inline col4'>Minzoom</label>
          <input <%= disabled %> id='minzoom' name='minzoom' class='min' type='range' value='<%= source.minzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "max", "#maxzoom");' />
          <span class='small quiet code inline range' id='minzoom-val'><%= source.minzoom %></span>
        </section>
        <section class='space-bottom0 clearfix'>
          <label class='inline col4'>Maxzoom</label>
          <input <%= disabled %> id='maxzoom' name='maxzoom' class='max' type='range' value='<%= source.maxzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "min", "#minzoom");' />
          <span class='small quiet code inline range' id='maxzoom-val'><%= source.maxzoom %></span>
        </section>
      </fieldset>
    </div>
    <div class='keyline-top pad2y settings-footer pin-bottom'>
    <% if (!remote) { %>
      <section class='col12 pad1x clearfix'>
        <div class='pad1x col6'>
          <a href='#' class='quiet button col12 icon js-save floppy'>Save</a>
        </div>
        <div class='pad1x col6'>
          <a href='/mbtiles?id=<%= source.id %>' class='quiet button col12 icon share'>Export</a>
        </div>
      </section>
    <% } else { %>
      <section class='pad2x clearfix'>
        <a href='#' class='col12 quiet button icon js-save floppy'>Save</a>
      </section>
    <% } %>
    </div>
  </div>
</form>

<form id='bookmark' class='tip-bottom z1 contain fill-dark round animate'>
  <input id='addbookmark' type='text' class='col12 clean round small' value='' placeholder='Name a bookmark' autocomplete='off' />
  <div class='pin-topright pad0'>
    <input type='submit' class='short quiet button' value='Add' />
  </div>
  <ul id='bookmark-list' class='clip fill-dark scroll-styled round-bottom'></ul>
</form>

<form id='search' class='tip-bottom z1 contain fill-dark round animate'>
  <input id='dosearch' type='text' class='col12 clean small round' value='' placeholder='Search' autocomplete='off' />
  <div class='pin-topleft pad1'>
    <span class='icon search'></span>
  </div>
  <ul id='search-results' class='clip fill-dark dark scroll-styled round-bottom'></ul>
</form>

<div id='full' class='clip animate pin-left'>
  <div id='title' class='contain inline pin-topleft z1'>
    <span class='inline clip fill-darken3 dark row1 round-bottomright'><!--
      --><a href='#user' class='inline avatar align-middle'><img src='<%= user.avatar %>' /></a><!--
      --><strong class='unround icon point-line project-name small js-name inline pad1'><%= source.name || 'Untitled' %></strong><!--
      --><span class='pad0x row1 inline'><!--
      --><a href='#settings' class='round-left icon sprocket short button inline keyline-right'>Settings</a><!--
      <% if (source._tmp) { %>
        --><a class='saveas round-right js-save short button icon inline floppy'>Save as</a>
      <% } else { %>
        --><a class='round-right js-save short button icon inline floppy' href='#'>Save</a>
      <% } %>
    </span>
  </div>
  <div id='map' class='animate dark' style='background-color:<%=source.background%>;'></div>
  <div id='map-overlay'></div>
  <div id='map-errors'></div>
  <div id='zoomedto' class='fill-dark contain z<%=source.center[2]%>'></div>

  <div id='map-controls'>
    <div class='inline'>
      <div class='z1 fill-dark'>
        <a href='#' id='zoom-in' title='Zoom in' class='icon plus keyline-right quiet'></a><!--
        --><a href='#' id='zoom-out' title='Zoom out' class='icon minus keyline-right quiet'></a>
      </div>
    </div>
    <div class='inline'>
      <div class='z1 fill-dark'>
        <a href='#search' title='Search' class='search-n dark keyline-right icon search quiet '></a><!--
        --><a href='#' title='Close search' class='search-y fill-darken2 icon keyline-right search'></a><!--
        --><a href='#bookmark' title='Bookmarks' class='bookmark-n dark icon marker quiet'></a><!--
        --><a href='#' title='Close bookmarks' class='bookmark-y fill-darken2 icon marker'></a>
      </div>
    </div>
    <a href='#full' title='Toggle fullscreen' class='full-n inline fill-dark icon fullscreen quiet'></a>
    <a href='#' title='Exit fullscreen' class='full-y fill-dark dark'><span class='fill-darken2 icon fullscreen'></span></a>
  </div>
  <div id='refresh' class='animate fill-darken2 col12 pad2 pin-bottom'>
    <span class='icon info'>To view visibility adjustments, <a href='#' class='js-save'>Save now</a>.</span>
    <a class='quiet pin-topright inline pad1 icon close'></a>
  </div>
</div>

<%
var revlayers = remote ? source.vector_layers.slice(0) : source.Layer.slice(0);
revlayers.reverse();
%>
<div id='source-ui' class='z1 animate menu source-menu fill-dark dark col6 pin-right'>

  <div id='docs' class='pane animate pin-left fill-dark scroll-styled col6'>
    <%= this['sourcedocs']() %>
  </div>
  <div id='layers'>
    <nav class='pad1x row1 col12 pin-top keyline-bottom fill-dark z1'>
      <div class='pin-topleft z1 row1'><!--
        --><a title='Documentation' class='pad1 inline docs-n icon help unround align-middle fill-darken0 keyline-right' href='#docs'></a><!--
        --><a title='Documentation' class='pad1 inline docs-y icon help unround align-middle fill-darken2 keyline-right' href='#'></a><!--
      --></div>
      <% if (remote) { %>
      <strong class='small inline pad1y pad4x'>Layers</strong>
      <% } else { %>
      <div class='inline pad0y pad4x'><a data-modal='addlayer' class='button quiet short icon plus'>Layers</a></div>
      <% } %>
      <div class='center pin-right col6 strong small'>
        <% if (!remote) { %>
        <span class='pad0x pad1y keyline-left col4 fr layer-label'>Delete</span>
        <% } %>
        <span class='pad0x pad1y col4 keyline-left fr layer-label'>Visibility</span>
        <% if (remote) { %>
        <span class='pad0x pad1y keyline-left col4 fr layer-label'>Zoom</span>
        <% } %>
      </div>
    </nav>
    <div class='js-menu-content menu-content fill-dark pin-left col12 top1 scroll-styled'>
      <% _(revlayers).each(function(l) {
        print(this.layeritem(_({_prefs:source._prefs}).extend(l)));
      }.bind(this)); %>
      <% if (!remote) { %>
        <%= this.emptystate({message:'You haven\'t imported any data layers yet. <a data-modal="addlayer">Add one now</a>.'}) %>
      <% } %>
    </div>
  </div>
</div>

<div class='z10' id='editor'>
<% if (!remote) {
  _(revlayers).each(function(l) {
    var type = (l.Datasource && l.Datasource.type);
    if (this['layer' + type]) print(this['layer' + type](_({
        tm: tm,
        vt: source.vector_layers.filter(function(v) { return v.id === l.id })[0]
    }).extend(l)));
  }.bind(this));
} %>
</div>

<% if (!remote) print(this.modalbrowser({
  id: 'browsefile',
  cwd: cwd,
  label: 'Select'
})); %>

<%= this.modaluser({name:user.name||user.id}) %>
<%= this.modalmessage() %>
<%= this.modalmapbox() %>
<%= this.modalbrowseropen({cwd:cwd, type:'style'}) %>
<%= this.modalbrowseropen({cwd:cwd, type:'source'}) %>
<%= source._tmp ? this.modalbrowsersave({cwd:cwd, type:'source'}) : '' %>

<% if (!remote) { %>
<form id='addlayer' class='modal round pad2 col6 margin3 fill-light'>
  <a href='#' class="pad1 quiet icon x pin-topright close"></a>
  <fieldset class='col8 margin2'>
    <p class='center'>Add a layer to your source.</p>
    <input class='col12 space-bottom1' type='text' placeholder='Name' title='No spaces, punctuation marks, or special characters allowed.' size='20' name='id' pattern='\w+'/>
  </fieldset>
  <fieldset class='col8 margin2'>
    <div class="space-bottom1 small quiet">Select the format of the data you wish to convert into a vector source:</div>
    <div class='col12 scroll-styled radio-buttons'>
      <input name='type' type='radio' id='addlayer-postgis' value='postgis' checked >
      <label class='contain icon check quiet short button col12' for='addlayer-postgis'>
        PostGIS
        <span class='micro pin-right quiet pad0y pad1x'>Database</span>
      </label>
      <input name='type' type='radio' id='addlayer-shape' value='shape'>
      <label class='contain icon check quiet short button col12' for='addlayer-shape'>
        Shapefile
        <span class='micro pin-right quiet pad0y pad1x'>.shp</span>
      </label>
      <input name='type' type='radio' id='addlayer-geojson' value='geojson'>
      <label class='contain icon check quiet short button col12' for='addlayer-geojson'>
        GeoJSON
        <span class='micro pin-right quiet pad0y pad1x'>.json &amp; .geojson</span>
        </label>
      <input name='type' type='radio' id='addlayer-sqlite' value='sqlite'>
      <label class='contain icon check quiet short button col12' for='addlayer-sqlite'>
        SQLite
        <span class='micro pin-right quiet pad0y pad1x'>Database</span>
      </label>
      <input name='type' type='radio' id='addlayer-csv' value='csv'>
      <label class='contain icon check quiet short button col12' for='addlayer-csv'>
        CSV
        <span class='micro pin-right quiet pad0y pad1x'>.csv</span>
      </label>
    </div>
  </fieldset>
  </div>
  <div class='center'>
  <input class='js-reset-mode margin2 col8' type='submit' value='New layer'/>
  </div>
</form>
<% } %>

<form id='message-modal' class='modal center round pad2 col6 margin3 fill-light'>
<a class="pad1 quiet icon x pin-topright close"></a>
<div class='message-modal-body'></div>
</form>

<a href='#' id='mask' class='fill-darken2 animate'></a>

<script>
var templates = {};
templates.layeritem = <%= this.layeritem.source %>;
templates.layerconf = <%= this.layerconf.source %>;
templates.layerfields = <%= this.layerfields.source %>;
templates.layershape = <%= this.layershape.source %>;
templates.layerpostgis = <%= this.layerpostgis.source %>;
templates.layergeojson = <%= this.layergeojson.source %>;
templates.layersqlite = <%= this.layersqlite.source %>;
templates.layercsv = <%= this.layercsv.source %>;
templates.xraycolor = <%= this.xraycolor.source %>;
templates.xraypopup = <%= this.xraypopup.source %>;

var tm = {};
tm.srs = <%= JSON.stringify(tm.srs) %>;

var source = <%= JSON.stringify(source) %>;
var revlayers = <%= JSON.stringify(revlayers) %>;

Source(templates, tm, source, revlayers);

<% if (!remote) { %>
// Sortable layers.
$('#layers .js-menu-content').sortable();
$('#layers .js-menu-content').bind('sortupdate', function(ev, ui) {
  var ids = $('#layers .js-menu-content .js-layer').map(function() {
    return $(this).attr('id');
  }).get();
  layers = _(ids).reduce(function(memo, id) {
    memo[id] = layers[id];
    return memo;
  }, {});
});
<% } %>
</script>
</body>

</html>
